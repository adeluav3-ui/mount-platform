<script>
    // Global state
    let logs = [];
    let oneSignalInstance = null;
    let isAndroidChrome = /Android.*Chrome/.test(navigator.userAgent);

    // Log function
    function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${message}`;
        logs.push(logEntry);

        const recentLogs = logs.slice(-10).join('\n');
        document.getElementById('actionLog').textContent = recentLogs;

        return logEntry;
    }

    // Update status display
    function updateStatus(elementId, message, className) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.className = `status ${className}`;
        log(`${elementId}: ${message}`);
    }

    // Check device
    function checkDevice() {
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const isChrome = /Chrome/.test(navigator.userAgent);

        let message = `üì± ${isMobile ? 'Mobile' : 'Desktop'} | `;
        message += `${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Other'} | `;
        message += `${isChrome ? 'Chrome' : 'Other Browser'} | `;
        message += `HTTPS: ${window.location.protocol === 'https:'} | `;
        message += `Permission: ${Notification.permission}`;

        updateStatus('deviceStatus', message, 'success');
        return isMobile;
    }

    // SPECIAL FIX for Android Chrome
    async function androidChromeFix() {
        log('üõ†Ô∏è Applying Android Chrome fix...');

        // Method 1: Direct Service Worker registration
        try {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                log('Registering Service Worker directly...');

                // Register Service Worker
                const registration = await navigator.serviceWorker.register('/OneSignalSDKWorker.js', {
                    scope: '/'
                });

                log(`Service Worker registered: ${registration.scope}`);

                // Get subscription
                const subscription = await registration.pushManager.getSubscription();

                if (subscription) {
                    const playerId = subscription.endpoint.split('/').pop();
                    log(`‚úÖ Got Player ID from Service Worker: ${playerId}`);
                    return playerId;
                } else {
                    log('No existing subscription found');
                }
            }
        } catch (error) {
            log(`Service Worker error: ${error.message}`, 'error');
        }

        // Method 2: Direct VAPID subscription (bypass OneSignal)
        try {
            log('Trying direct VAPID subscription...');

            // You need a VAPID public key - I'll provide a test one
            const vapidPublicKey = 'BINUYd8-pxRnZ6KZ-TZ_7UKcETNdK_LiJGbK3B8C7nv18X9PkAjA_nf-0iyqYS8OT0-aqsFRP-V3qAjObYqoO2U';

            const registration = await navigator.serviceWorker.ready;
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
            });

            const playerId = JSON.stringify(subscription);
            log(`‚úÖ Direct subscription successful`);
            log(`Subscription: ${playerId.substring(0, 100)}...`);

            return subscription.endpoint.split('/').pop();

        } catch (error) {
            log(`Direct subscription error: ${error.message}`, 'error');
        }

        return null;
    }

    // Helper for VAPID key
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    // Load OneSignal SDK
    async function loadOneSignalSDK() {
        updateStatus('sdkStatus', 'Loading OneSignal SDK...', 'loading');

        return new Promise((resolve) => {
            document.querySelectorAll('script[src*="onesignal.com"]').forEach(s => s.remove());

            const script = document.createElement('script');
            script.src = 'https://cdn.onesignal.com/sdks/OneSignalSDK.js';
            script.async = true;

            script.onload = () => {
                log('‚úÖ OneSignal SDK loaded');
                updateStatus('sdkStatus', '‚úÖ SDK Loaded', 'success');
                resolve(true);
            };

            script.onerror = () => {
                log('‚ùå Failed to load OneSignal SDK', 'error');
                updateStatus('sdkStatus', '‚ùå SDK Failed', 'error');
                resolve(false);
            };

            document.head.appendChild(script);
        });
    }

    // Initialize OneSignal with timeout
    async function initializeOneSignal() {
        updateStatus('sdkStatus', 'Initializing...', 'loading');

        return new Promise((resolve) => {
            window.OneSignal = window.OneSignal || [];

            // Set timeout
            const timeout = setTimeout(() => {
                log('‚ö†Ô∏è OneSignal init timeout - using fallback', 'warn');
                updateStatus('sdkStatus', '‚ö†Ô∏è Using Fallback', 'warning');
                resolve(false);
            }, 5000);

            OneSignal.push(function () {
                clearTimeout(timeout);

                try {
                    // SIMPLIFIED initialization for Android Chrome
                    OneSignal.init({
                        appId: "0186919f-3891-40a5-81b6-c9e70634bdef",
                        autoRegister: false, // DON'T auto register
                        notifyButton: {
                            enable: false,
                        },
                        promptOptions: {
                            slidedown: {
                                enabled: false // Disable auto-prompt
                            }
                        }
                    });

                    oneSignalInstance = window.OneSignal;
                    log('‚úÖ OneSignal initialized (autoRegister disabled)');
                    updateStatus('sdkStatus', '‚úÖ Initialized', 'success');
                    resolve(true);

                } catch (error) {
                    log(`‚ùå Init error: ${error.message}`, 'error');
                    updateStatus('sdkStatus', '‚ùå Init Failed', 'error');
                    resolve(false);
                }
            });
        });
    }

    // MANUAL subscription for Android Chrome
    async function manualSubscribe() {
        log('Starting MANUAL subscription process...');
        updateStatus('subStatus', 'Manual subscription...', 'loading');

        // STEP 1: Try Android Chrome specific fix
        if (isAndroidChrome) {
            log('Applying Android Chrome specific fix...');
            const playerId = await androidChromeFix();
            if (playerId) {
                updateStatus('subStatus', `‚úÖ Android Fix Worked!`, 'success');
                document.getElementById('playerIdDisplay').textContent = playerId;
                document.getElementById('playerIdContainer').style.display = 'block';
                return playerId;
            }
        }

        // STEP 2: Try manual Service Worker subscription
        try {
            log('Trying manual Service Worker push...');

            if ('serviceWorker' in navigator && 'PushManager' in window) {
                const registration = await navigator.serviceWorker.ready;

                // Check current subscription
                let subscription = await registration.pushManager.getSubscription();

                if (!subscription) {
                    log('No subscription, creating one...');

                    // Get VAPID key from OneSignal
                    const response = await fetch('https://onesignal.com/api/v1/players/cjs_keys');
                    const data = await response.json();

                    if (data.enterprise) {
                        const vapidKey = data.enterprise;
                        subscription = await registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: urlBase64ToUint8Array(vapidKey)
                        });

                        const playerId = subscription.endpoint.split('/').pop();
                        log(`‚úÖ Manual subscription created: ${playerId}`);

                        // Send to OneSignal
                        if (oneSignalInstance && oneSignalInstance.setSubscription) {
                            await oneSignalInstance.setSubscription(true);
                        }

                        updateStatus('subStatus', `‚úÖ Manual Success!`, 'success');
                        document.getElementById('playerIdDisplay').textContent = playerId;
                        document.getElementById('playerIdContainer').style.display = 'block';
                        return playerId;
                    }
                } else {
                    const playerId = subscription.endpoint.split('/').pop();
                    log(`‚úÖ Already subscribed: ${playerId}`);
                    updateStatus('subStatus', `‚úÖ Already Subscribed`, 'success');
                    document.getElementById('playerIdDisplay').textContent = playerId;
                    document.getElementById('playerIdContainer').style.display = 'block';
                    return playerId;
                }
            }
        } catch (error) {
            log(`Manual subscription error: ${error.message}`, 'error');
        }

        // STEP 3: Last resort - show alert with instructions
        updateStatus('subStatus', '‚ùå Need Manual Steps', 'error');
        log('Showing manual instructions...');

        const manualSteps = `
üì± ANDROID CHROME FIX REQUIRED:

1. Go to Chrome Settings ‚Üí Site Settings ‚Üí Notifications
2. Find "mountltd.com" and set to "Allow"
3. Clear Chrome cache: Settings ‚Üí Privacy ‚Üí Clear browsing data
4. Restart Chrome
5. Return to this page and try again

OR try this:
1. Open Chrome in Incognito mode
2. Go to https://mountltd.com
3. Log in as a company
4. See if notifications work

Still stuck? Email support@mountltd.com
`;

        alert(manualSteps);
        return null;
    }

    // Check subscription
    async function checkSubscription() {
        updateStatus('subStatus', 'Checking...', 'loading');

        if (!oneSignalInstance) {
            // Try direct Service Worker check
            try {
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.ready;
                    const subscription = await registration.pushManager.getSubscription();

                    if (subscription) {
                        const playerId = subscription.endpoint.split('/').pop();
                        updateStatus('subStatus', `‚úÖ Subscribed via SW`, 'success');
                        document.getElementById('playerIdDisplay').textContent = playerId;
                        document.getElementById('playerIdContainer').style.display = 'block';
                        return playerId;
                    }
                }
            } catch (error) {
                log(`SW check error: ${error.message}`);
            }

            updateStatus('subStatus', '‚ùå Not initialized', 'error');
            return null;
        }

        // Try to get Player ID directly
        try {
            // Wait a moment
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Method 1: getUserId
            if (typeof oneSignalInstance.getUserId === 'function') {
                const playerId = await oneSignalInstance.getUserId();
                if (playerId) {
                    updateStatus('subStatus', `‚úÖ Player ID: ${playerId.substring(0, 8)}...`, 'success');
                    document.getElementById('playerIdDisplay').textContent = playerId;
                    document.getElementById('playerIdContainer').style.display = 'block';
                    return playerId;
                }
            }

            // Method 2: Direct property access
            if (oneSignalInstance._isInitialized && oneSignalInstance._sessionManager) {
                const playerId = oneSignalInstance._sessionManager.getPlayerId();
                if (playerId) {
                    updateStatus('subStatus', `‚úÖ Got Player ID`, 'success');
                    document.getElementById('playerIdDisplay').textContent = playerId;
                    document.getElementById('playerIdContainer').style.display = 'block';
                    return playerId;
                }
            }

            updateStatus('subStatus', '‚ùå No Player ID found', 'error');
            return null;

        } catch (error) {
            updateStatus('subStatus', `‚ùå Error: ${error.message}`, 'error');
            return null;
        }
    }

    // Auto fix everything
    async function autoFixEverything() {
        log('üöÄ Starting Android Chrome fix...');

        // 1. Check device
        checkDevice();

        // 2. Load SDK
        await loadOneSignalSDK();

        // 3. Initialize (with autoRegister disabled)
        await initializeOneSignal();

        // 4. MANUAL subscription (bypass OneSignal's broken methods)
        const playerId = await manualSubscribe();

        if (playerId) {
            log(`üéâ SUCCESS! Player ID: ${playerId}`);
            alert(`‚úÖ MOBILE FIXED!\n\nPlayer ID: ${playerId}\n\nYour device should now appear in OneSignal dashboard.`);
        } else {
            log('‚ùå Manual fix also failed');
            alert('‚ùå Could not fix automatically. Please follow the manual instructions shown.');
        }
    }

    // Set up buttons
    document.getElementById('fixBtn').addEventListener('click', autoFixEverything);
    document.getElementById('reloadBtn').addEventListener('click', loadOneSignalSDK);
    document.getElementById('permissionBtn').addEventListener('click', () => {
        Notification.requestPermission().then(p => {
            alert(`Permission: ${p}`);
            checkDevice();
        });
    });
    document.getElementById('subscribeBtn').addEventListener('click', manualSubscribe);

    // Initialize
    window.addEventListener('load', () => {
        checkDevice();
        loadOneSignalSDK().then(() => {
            initializeOneSignal().then(() => {
                checkSubscription();
            });
        });
    });
</script>